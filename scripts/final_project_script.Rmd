---
title: "Title of Papers"
author: "TEAM QRME"
date: "11/10/2021"
output: 
    html_document:
        toc_flot: true
        toc_depth: 3
        highlight: pygments
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE)

# Add your packages that you need here. This will load the libraries
#removed purr - part of tidyverse
#let's only include libraries we are using so that others don't have to install the irrelevant ones 
if (!require("pacman")) install.packages("pacman") 
#pacman::p_load(tidyverse, rio, here, ggridges, readr, ggthemes, sandwich, pracma, lme4,equatiomatic, performance, jtools, sundry,naniar,stargazer,vtable, reshape2, skimr, rddtools,tidylog,janitor) 
pacman::p_load(tidyverse, rio, here, ggridges, ggthemes, skimr, tidylog, janitor, reshape2, psych) 

```

# Abstract

# Introduction 

## Cleaning different files {.tabset}

### School Enrollment Cleaning

In this section, I will import the enrollment file and subset it to keep relevant variables. This file will be the base file. 

```{r }
#Importing the Enrollment file
enroll<- read_csv(here("data", "Enrollment.csv")) %>%
  as_tibble() %>%
  subset(select = -c(9:31))
```

Exploring the file - I notice that there are some minimum values that are less than
zero, negative values don't make sense for enrollment. Need to replace those to 
missing.

```{r }
skim(enroll)
``` 


First, need to replace values that have negative values with a missing value, then
creating enrollment counts for race/ethnicity groups as well as EL and SPED.

```{r }
enroll <- enroll %>%
  mutate_all(~replace(., . < 0, NA)) %>%
  mutate(enroll_all = TOT_ENR_M + TOT_ENR_F,
         enroll_latinx = SCH_ENR_HI_M + SCH_ENR_HI_F,
         enroll_aian = SCH_ENR_AM_M + SCH_ENR_AM_F,
         enroll_asianam = SCH_ENR_AS_M + SCH_ENR_AS_F,
         enroll_nhpi = SCH_ENR_HP_M + SCH_ENR_HP_F,
         enroll_black = SCH_ENR_BL_M + SCH_ENR_BL_F,
         enroll_white = SCH_ENR_WH_M + SCH_ENR_WH_F,
         enroll_twomore = SCH_ENR_TR_M + SCH_ENR_TR_F,
         enroll_el = SCH_ENR_LEP_M + SCH_ENR_LEP_F,
         enroll_elserv = TOT_LEPPROGENR_M + TOT_LEPPROGENR_F,
         enroll_sped = SCH_ENR_IDEA_M + SCH_ENR_IDEA_F)
```

Checking to see if the code worked by checking the distribution of all the variables. 
In theory, none should go below zero in these box graphs. Based on the results, it appears
as if this worked out well 

```{r }
enroll %>% 
  melt(id.vars = "SCH_NAME", 
       measure.vars = c("enroll_all", "enroll_latinx", "enroll_aian", "enroll_asianam",
                        "enroll_nhpi", "enroll_black", "enroll_white", "enroll_twomore",
                        "enroll_el", "enroll_elserv", "enroll_sped"),
       variable.name = "Group",
       value.name = "Count") %>%
  ggplot(aes(x = Count, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
```

Now creating a set of new variables. I am creating enrollment percents for each
race/ethnicity group as well as EL and SPED.

```{r }
enroll <- enroll %>%
  mutate(enroll_latinx_pct = (enroll_latinx/enroll_all)*100,
         enroll_aian_pct = (enroll_aian/enroll_all)*100,
         enroll_asianam_pct = (enroll_asianam/enroll_all)*100,
         enroll_nhpi_pct = (enroll_nhpi/enroll_all)*100,
         enroll_black_pct = (enroll_black/enroll_all)*100,
         enroll_white_pct = (enroll_white/enroll_all)*100,
         enroll_twomore_pct = (enroll_twomore/enroll_all)*100,
         enroll_el_pct = (enroll_el/enroll_all)*100,
         enroll_elserv_pct = (enroll_elserv/enroll_all)*100,
         enroll_sped_pct = (enroll_sped/enroll_all)*100)
```

Also checking to see distribution of all the variables by ploting them. I notice some 
are reporting percents higher than 100. For example, some schools, the percent of students
who are EL enrolled is greater than 100. This shouldn't be the case.

```{r }
enroll %>% 
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "enroll_latinx_pct", "enroll_aian_pct", "enroll_asianam_pct",
                        "enroll_nhpi_pct", "enroll_black_pct", "enroll_white_pct", "enroll_twomore_pct",
                        "enroll_el_pct", "enroll_elserv_pct", "enroll_sped_pct"),
       variable.name = "Group",
       value.name = "Count") %>%
  ggplot(aes(x = Count, y = Group)) +
  geom_boxplot() + 
  theme_minimal()

enroll %>%
    filter(enroll_el_pct > 100) %>%
    select(SCH_NAME,SCH_ENR_LEP_F,SCH_ENR_LEP_M, enroll_el, enroll_all, enroll_el_pct)
```

Recoding those schools that report percentages higher than 100. Doing this for EL% and SPED%.
For those cases, I just recoded back to 100 percent. It appears like it worked based on the visual.
Afterwards, I subset the file to only keep the school information, enrollment totals, and percent enrollment.

```{r }
enroll <- enroll %>%
  mutate(enroll_el_pct = ifelse(enroll_el_pct > 100,100,enroll_el_pct),
         enroll_elserv_pct = ifelse(enroll_elserv_pct > 100,100,enroll_elserv_pct),
         enroll_sped_pct = ifelse(enroll_sped_pct > 100,100,enroll_sped_pct)) 
```
  
Creating  District Level Independent variables (% EL, % SPED, % students of color)

```{r }
enroll <- enroll %>%
  group_by(LEAID) %>%
  mutate(dist_enrollment = sum(enroll_all),
         dist_percent_white = (sum(enroll_white)/dist_enrollment)*100,
         dist_percent_latinx = (sum(enroll_latinx)/dist_enrollment)*100,
         dist_percent_black = (sum(enroll_black)/dist_enrollment)*100,
         dist_percent_twomore = (sum(enroll_twomore)/dist_enrollment)*100,
         dist_percent_asianam= (sum(enroll_asianam)/dist_enrollment)*100,
         dist_percent_nhpi = (sum(enroll_nhpi)/dist_enrollment)*100,
         dist_percent_aian = (sum(enroll_aian)/dist_enrollment)*100,
         dist_percent_el = (sum(enroll_el)/dist_enrollment)*100,
         dist_percent_sped = (sum(enroll_sped)/dist_enrollment)*100
         )

enroll %>%
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
                        "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
                        "dist_percent_aian", "dist_percent_el", "dist_percent_sped"),
       variable.name = "Group",
       value.name = "Percent") %>%
  ggplot(aes(x = Percent, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
  


enroll %>%
  ggplot(aes(x = dist_enrollment, y = LEA_STATE_NAME)) +
  geom_density_ridges() + theme_minimal()
```

Replacing district rates with values greater than 100 to just 100

```{r }

enroll <- enroll %>%
  mutate(dist_percent_el = ifelse(dist_percent_el > 100,100,dist_percent_el),
         dist_percent_sped = ifelse(dist_percent_sped > 100,100,dist_percent_sped))

enroll %>%
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
                        "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
                        "dist_percent_aian", "dist_percent_el", "dist_percent_sped"),
       variable.name = "Group",
       value.name = "Percent") %>%
  ggplot(aes(x = Percent, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
``` 
  
Making the dataset smaller and just keeping variables that we need  
  
```{r }  
enroll <- enroll %>%  
select(c("LEA_STATE", "LEA_STATE_NAME", "LEAID", "LEA_NAME", "SCHID", "SCH_NAME", 
          "COMBOKEY", "JJ",  "enroll_all", "enroll_latinx", "enroll_aian", "enroll_asianam",
           "enroll_nhpi", "enroll_black", "enroll_white", "enroll_twomore",
           "enroll_el", "enroll_elserv", "enroll_sped","enroll_latinx_pct", 
          "enroll_aian_pct", "enroll_asianam_pct", "enroll_nhpi_pct", "enroll_black_pct", 
          "enroll_white_pct", "enroll_twomore_pct","enroll_el_pct", "enroll_elserv_pct", "enroll_sped_pct",
          "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
          "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
          "dist_percent_aian", "dist_percent_el", "dist_percent_sped"))
```

*END OF ENROLLMENT DATA CLEANING*

### School Characteristic Cleaning

### Suspension Expulsion Cleaning

### Harassemnt/Bullying Cleaning

Let's read the data.
```{r read data}
hnb <- import(here("data","Harassment and Bullying.csv")) %>% 
    as_tibble()
hnb_col <- colnames(hnb)
```

**Quick summary:**

* There are `r ncol(hnb)` variables in this dataset.   
* First 8 are school characteristics  
* 9-13 are Harassment and Bullying allegations -- Allegations based on sex, ethnicity, disability status, sexual orientation and religion. Total varianles: `r length(grep("SCH_HBALLEGATIONS", hnb_col))`  
* 14 - 79 are #students reported as being bullied by different intent and demographic characteristics. Total variables: `r length(grep("SCH_HBREPORTED", hnb_col))`  
* 80 - 145 are #students discilined for bullying or harassing by different intent and demographic characteristics. Total variables: `r length(grep("SCH_DISCIPLINED", hnb_col))`  
* Totals are available (starts with TOT) for different intent (rex, race and disability status), reported/disciplined and gender (male, female) combo. Total variables for reported: `r length(grep("TOT_HBREPORTED", hnb_col))`, and Total variables for disciplined: `r length(grep("TOT_HBDISCIPLINED", hnb_col))`   

//_Note to self:_ `grep()` saves the indices of columns

First, let's change all negative numbers to NA. 

```{r hnb_pos}
#function to remove negative values
remove_neg <- function (x) ifelse(x < 0, NA, x)
hnb_pos <- hnb %>% 
    mutate(across(c(9:145), remove_neg))
```

Nice!

Let's make a shorter dataset to work with. I have allegations, reported and disciplined for the following intents: sex, race and disability. Let's just take these forward.

```{r hnb_sub}
#function to find relevant columns and sum them
cat_sum <- function(x, y) rowSums(select(x, starts_with(y)), na.rm = TRUE)

hnb_sub <- hnb_pos %>% 
    select("LEA_STATE","LEA_NAME","COMBOKEY", starts_with(c("SCH_HBALLEGATIONS","TOT_HBREPORTED","TOT_HBDISCIPLINED"))) %>% 
    mutate(TOT_HBREPORTED_SEX = cat_sum(.,"TOT_HBREPORTED_SEX"),
           TOT_HBREPORTED_RAC = cat_sum(.,"TOT_HBREPORTED_RAC"),
           TOT_HBREPORTED_DIS = cat_sum(.,"TOT_HBREPORTED_DIS"),
           TOT_HBDISCIPLINED_SEX = cat_sum(.,"TOT_HBDISCIPLINED_SEX"),
           TOT_HBDISCIPLINED_RAC = cat_sum(.,"TOT_HBDISCIPLINED_RAC"),
           TOT_HBDISCIPLINED_DIS = cat_sum(.,"TOT_HBDISCIPLINED_DIS"),
           TOT_HBALLEGATIONS = cat_sum(.,"SCH_HBALLEGATIONS"),
           TOT_HBREPORTED = cat_sum(.,"TOT_HBREPORTED"),
           TOT_HBDISCIPLINED = cat_sum(.,"TOT_HBDISCIPLINED")) %>% 
    filter(if_any(c(27:29),~ . > 0))
```

That looks like a neat data set. We have total `r ncol(hnb_sub)` variables - 3 are identifiers and rest are numeric. Also, we have filtered out rows where all numeric columns are 0.

Let's find some summary of cols.

```{r summary}
skim(hnb_sub)

```

This is super interesting! Some conclusions: 

* Allegations are highest, followed by disciplined and then reported. Probably, some teacher/adult saw the incident and disciplined the students involved, and hence things were not reported. Or, one student reported multiple people, hence the whole group was disciplined.    
* Allegation, reported and disciplined have highest raw count for the 'Disability' intent, followed by 'sex' and 'race'. However, the mean in all categories follow the order: 'sex', 'race' and 'disability'
* In reported, often female students report more frequencty for 'sex' intent, but male students report more often for 'race' and 'disability'
* In disciplined, for all intents, male students are more often disciplined than female students.

Let's do some plots now.

```{r scatter plot matrix allegations, out.width="100%"}

pairs.panels(hnb_sub[,4:8], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )

#pairs(hnb_sub[,4:8], pch = 19, lower.panel = NULL)
#plotmatrix(hnb_sub[,27:29], colour="gray20")
```

```{r total, out.width="100%"}
pairs.panels(hnb_sub[,27:29], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )
```
        
```{r group total, out.width="100%"}
pairs.panels(hnb_sub[,21:26], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )
```

Let's look at state-wide boxplot, but each point represents the district

```{r state and district, out.width="100%"}
hnb_sub2 <- hnb_sub %>% 
    group_by(LEA_NAME) %>% 
    mutate(district_all = mean(TOT_HBALLEGATIONS),
           district_rep = mean(TOT_HBREPORTED),
           district_dis = mean(TOT_HBDISCIPLINED))

hnb_sub2 %>% 
    group_by(LEA_STATE) %>% 
    ggplot() +
    geom_boxplot(aes(LEA_STATE, district_all))
```

Though exciting to do initial data analysis, let's make a data file we'll be using for the final analysis.

```{r columns from enroll and hnb}
hnb_trim <- hnb_pos %>% 
   mutate(TOT_HBDISCIPLINED = cat_sum(., "TOT_HBDISCIPLINED")) %>% 
   select("COMBOKEY", "TOT_HBDISCIPLINED")

enroll_trim <- enroll %>% 
      select(c(1:9))

dis_enrol <- left_join(enroll_trim,hnb_trim, by = "COMBOKEY") %>% 
    mutate(HNB_ENROL = ((TOT_HBDISCIPLINED*1000)/enroll_all)) %>% 
    filter(HNB_ENROL <= 1000)
```

```{r}
dis_enrol %>% 
    ggplot() +
        geom_histogram(aes(x = HNB_ENROL), bins = 200)+
        xlim(0,1000)+
        ylim(0, 300)
```

### Arrests and Referrals

# Methods

# Results

# Discussion

# References


